<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Matplotlib 懶人包｜Lazy</title>
  <script>
    window.tailwind = {config:{safelist:['ring-2','ring-emerald-500','bg-emerald-700','bg-amber-700','bg-zinc-700','hover:bg-zinc-600','border-emerald-600','border-emerald-700/50','bg-emerald-500/10','bg-emerald-500/20','bg-emerald-500/30']}}
  </script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="min-h-screen bg-zinc-950 text-zinc-100">
  <div id="root"></div>
  <script type="text/babel">
    const {useState,useEffect,useRef,useContext,createContext,useCallback,useMemo,startTransition,useDeferredValue} = React;

    function parseHash(h) {
      const raw = (h || "").replace(/^#/, "").replace(/^\/+/, "");
      const parts = raw ? raw.split("/") : [];
      const section = parts[0] || "home";
      const sub = parts[1] || "";
      const item = parts[2] || "";
      return { section, sub, item };
    }
    function buildHash({ section, sub, item }) {
      const segs = [section || "home"];
      if (sub) segs.push(sub);
      if (item) segs.push(item);
      return "#/" + segs.join("/");
    }

    function useHashRouter(){
      const [state,setState] = useState(()=>parseHash(location.hash));
      const lastHash = useRef(location.hash);
      const writeHash = next => {
        const h = buildHash(next);
        if(h===lastHash.current) return;
        lastHash.current = h;
        Promise.resolve().then(()=>{location.hash = h;});
      };
      useEffect(()=>{
        const onHash = () => {
          startTransition(()=>{
            const next = parseHash(location.hash);
            lastHash.current = location.hash;
            setState(next);
          });
        };
        addEventListener('hashchange', onHash);
        return ()=> removeEventListener('hashchange', onHash);
      },[]);
      const setRoute = next => {
        const merged = {...state,...next};
        startTransition(()=>setState(merged));
        writeHash(merged);
      };
      return [state,setRoute];
    }

    const RunContext = createContext();
    function RunProvider({children}){
      const runEpochRef = useRef(0);
      const listeners = useRef(new Set());
      const register = fn => {listeners.current.add(fn);return ()=>listeners.current.delete(fn);};
      const broadcastClear = keepId => {listeners.current.forEach(fn=>fn(keepId));};
      const start = id => {runEpochRef.current++;broadcastClear(id);return runEpochRef.current;};
      const done = (id,epoch) => runEpochRef.current===epoch;
      const value = {start,done,register};
      return <RunContext.Provider value={value}>{children}</RunContext.Provider>;
    }

    class PyWorker{
      constructor(){this.restart();}
      restart(){
        if(this.worker){this.worker.onmessage=null;this.worker.onerror=null;this.worker.terminate();URL.revokeObjectURL(this.url);}
        const src = `
self.importScripts("https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js");

let pyReady = (async () => {
  // 重要：Blob Worker 一定要設定 indexURL，否則部署後會 404
  self.pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.1/full/" });
  await self.pyodide.loadPackage(["numpy", "matplotlib"]);
  await self.pyodide.runPythonAsync(\`
import matplotlib
matplotlib.use("agg")
from matplotlib import rcParams
rcParams['font.family'] = ['DejaVu Sans']
rcParams['axes.unicode_minus'] = True

import matplotlib.pyplot as plt
import numpy as np
import io, base64, gc

# 預先註冊投影，避免惰性載入失敗
try:
    from mpl_toolkits.mplot3d import Axes3D  # noqa: F401
except Exception:
    pass
try:
    from matplotlib.projections import get_projection_class
    _ = get_projection_class('polar')
    _ = get_projection_class('3d')
except Exception:
    pass

def _encode_fig(fig):
    bio = io.BytesIO()
    fig.savefig(bio, format='png', bbox_inches='tight', dpi=96)
    return "data:image/png;base64," + base64.b64encode(bio.getvalue()).decode()

def _capture(images):
    try:
        fignums = list(plt.get_fignums())
    except Exception:
        fignums = []
    for num in fignums[:6]:
        try:
            fig = plt.figure(num)
            images.append(_encode_fig(fig))
        except Exception:
            pass
    if len(fignums) > 6:
        images.append("TRUNCATED")
    for num in fignums:
        try:
            plt.close(num)
        except Exception:
            pass

def _run(code_str):
    import matplotlib.image as mpimg
    images = []
    plt.close('all')
    _orig_show = plt.show
    def _show_hook(*args, **kwargs):
        _capture(images)
    try:
        plt.show = _show_hook
        ns = {}
        exec(code_str, {'np':np, 'plt':plt, 'mpimg':mpimg}, ns)
    finally:
        _capture(images)
        plt.show = _orig_show
    gc.collect()
    return images
  \`);
})();

self.onmessage = async (e) => {
  const { code, token } = e.data;
  try {
    await pyReady;
    self.pyodide.globals.set("USER_CODE", code);
    const imgs = await self.pyodide.runPythonAsync("_run(USER_CODE)")
      .then(res => res.toJs({ create_proxies: false }));
    self.pyodide.globals.delete("USER_CODE");
    self.postMessage({ ok: true, token, imgs });
  } catch (err) {
    self.postMessage({ ok: false, token, err: String(err && err.message ? err.message : err) });
  }
};
        `;
        const blob = new Blob([src],{type:'text/javascript'});
        this.url = URL.createObjectURL(blob);
        this.worker = new Worker(this.url);
      }
      post(data){this.worker.postMessage(data);}  
    }

    const workerSingle = {current:null};
    function useWorker(){
      if(!workerSingle.current){workerSingle.current = new PyWorker();}
      useEffect(()=>()=>{
        const w = workerSingle.current; if(!w) return;
        w.worker.onmessage=null;w.worker.onerror=null;w.worker.terminate();URL.revokeObjectURL(w.url);workerSingle.current=null;
      },[]);
      return workerSingle.current;
    }

    function CodeBlock({id,code,projection}){
      const {start,done,register} = useContext(RunContext);
      const worker = useWorker();
      const [state,setState] = useState({running:false,imgs:[],err:null});
      const tokenRef = useRef(0);
      useEffect(()=> register(keep=>{if(keep!==id)setState({running:false,imgs:[],err:null});}),[id]);
      const deferred = useDeferredValue(useMemo(()=>code,[code]));
      const run = ()=>{
        const epoch = start(id);
        const token = ++tokenRef.current;
        setState({running:true,imgs:[],err:null});
        const src = `
import matplotlib.pyplot as plt
fig = plt.figure()
ax = fig.add_subplot(111${projection?`, projection='${projection}'`:''})
${code}
`;
        // set handler before posting to avoid race with worker response
        worker.worker.onmessage = e=>{
          const {ok,token:rt,imgs,err} = e.data;
          if(rt!==token) return;
          if(!done(id,epoch)) return;
          if(ok) setState({running:false,imgs,err:null});
          else setState({running:false,imgs:[],err});
        };
        worker.post({code:src,token});
      };
      return <div className="mb-6">
        <pre className="bg-zinc-800 p-4 rounded text-sm overflow-auto w-full"><code>{deferred}</code></pre>
        <div className="flex gap-2 mb-2">
          <button onClick={run} className="px-3 py-1 bg-emerald-700 hover:bg-emerald-600 rounded">執行</button>
          <button onClick={()=>setState({running:false,imgs:[],err:null})} className="px-3 py-1 bg-zinc-700 hover:bg-zinc-600 rounded">清空輸出</button>
        </div>
        {state.running && <div className="text-amber-500">執行中...</div>}
        {state.err && <div className="text-rose-500 whitespace-pre-wrap">{state.err}</div>}
        <div className="space-y-2">
          {state.imgs.map((img,i)=> img==='TRUNCATED' ? <div key={i} className="text-amber-500">已截斷</div> : <img key={i} src={img} className="w-full" />)}
        </div>
      </div>;
    }

    function App(){
      const [route,setRoute] = useHashRouter();
      const changeSection = s=> startTransition(()=>setRoute({section:s}));
      return <div>
        <header className="p-4 flex gap-4 bg-zinc-900 sticky top-0">
          {['home','funcs'].map(sec=>
            <button key={sec} onClick={()=>changeSection(sec)} className={`px-2 py-1 rounded ${route.section===sec?'bg-emerald-700':'bg-zinc-700 hover:bg-zinc-600'}`}>{sec}</button>
          )}
        </header>
        <main className="p-4">
          {route.section==='home' && <h1 className="text-3xl mb-4">Matplotlib 懶人包</h1>}
          {route.section==='funcs' && <div>
            <h2 className="text-2xl mb-4">範例</h2>
            <CodeBlock id="polar" projection="polar" code={`ax.plot([0,1,2],[0,1,0])\n`} />
            <CodeBlock id="three" projection="3d" code={`ax.plot([0,1],[0,1],[0,1])\n`} />
          </div>}
        </main>
      </div>;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RunProvider><App/></RunProvider>);
  </script>
</body>
</html>

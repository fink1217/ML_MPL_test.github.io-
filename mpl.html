<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Matplotlib æ‡¶äººåŒ…ï½œç©©å®šç‰ˆï¼ˆWorker + å–®ä¸€åŸ·è¡Œ + æŠ•å½±é è¼‰ï¼‰</title>

    <!-- Tailwindï¼ˆå«å°‘é‡ safelistï¼‰ -->
    <script>
      window.tailwind = {
        config: {
          safelist: [
            'ring-2','ring-emerald-500',
            'bg-emerald-700','bg-amber-700','bg-zinc-700','hover:bg-zinc-600',
            'border-emerald-600','border-emerald-700/50',
            'bg-emerald-500/10','bg-emerald-500/20','bg-emerald-500/30'
          ]
        }
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React 18 + Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="min-h-screen bg-zinc-950 text-zinc-100">
    <div id="root"></div>

    <script type="text/babel">
      const { useMemo, useState, useEffect, useRef, useContext, createContext, useCallback } = React;

      // ğŸ‘‰ Dev-only error overlayï¼ˆå¯ç§»é™¤ï¼‰
      (function(){
        const div = document.createElement('div');
        div.style.cssText = 'position:fixed;left:8px;bottom:8px;max-width:50vw;z-index:99999;background:#111827;color:#fca5a5;border:1px solid #374151;border-radius:8px;padding:8px 10px;font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;display:none;white-space:pre-wrap;';
        document.body.appendChild(div);
        function show(msg){ div.textContent = msg; div.style.display='block'; }
        window.addEventListener('error', e => show('JS Error: ' + (e.message || e.error)));
        window.addEventListener('unhandledrejection', e => show('Promise Rejection: ' + (e.reason && (e.reason.message || e.reason)) ));
      })();

      /* ========= å°å·¥å…· ========= */
      const slugifyItemName = (name) => name.replace(/\s+/g, '').replace(/\(.*\)/, '').replace(/[^a-zA-Z0-9._]/g, '-');
      const tokensFromName = (name) => { const s = new Set(); const m = name.match(/[a-zA-Z_]\w*(?:\.[a-zA-Z_]\w*)*/g); if (m) m.forEach(t=>s.add(t)); if (name.includes('@')) s.add('@'); return Array.from(s); };
      let _nextCbId = 1; const genCbId = () => `cb-${_nextCbId++}`;

      /* ========= è¡Œå…§è¨»è§£ï¼šåƒ…é¡¯ç¤ºèˆ‡è¤‡è£½ï¼Œä¸å½±éŸ¿åŸ·è¡Œ ========= */
      function explainOne(stmt){
        const s = stmt.trim();
        if (!s) return "ç©ºè¡Œ";
        if (s.startsWith("#")) return "è¨»è§£";
        if (/^import numpy as np\b/.test(s)) return "åŒ¯å…¥ NumPy ä¸¦å‘½åç‚º np";
        if (/^import matplotlib\.pyplot as plt\b/.test(s)) return "åŒ¯å…¥ Matplotlib ä¸¦å‘½åç‚º plt";
        if (/^import matplotlib\.image as mpimg\b/.test(s)) return "åŒ¯å…¥å½±åƒæ¨¡çµ„ mpimg";
        if (/^from mpl_toolkits\.mplot3d import /.test(s)) return "å•Ÿç”¨ 3D æŠ•å½±ï¼ˆç›¸å®¹èˆŠç‰ˆï¼‰";
        if (/^\w+\s*=\s*np\.linspace\(/.test(s)) return `å»ºç«‹ç­‰é–“è·å‘é‡ ${s.split('=')[0].trim()}`;
        if (/^\w+\s*=\s*np\.meshgrid\(/.test(s)) return "å»ºç«‹ç¶²æ ¼åº§æ¨™ X, Y";
        if (/^\w+\s*=\s*np\.sin\(/.test(s)) return "è¨ˆç®—æ­£å¼¦";
        if (/^\w+\s*=\s*np\.cos\(/.test(s)) return "è¨ˆç®—é¤˜å¼¦";
        if (/^\w+\s*=\s*np\.sqrt\(/.test(s)) return "å¹³æ–¹æ ¹";
        if (/^np\.random\.seed\(/.test(s)) return "è¨­å®šéš¨æ©Ÿç¨®å­ï¼ˆå¯é‡ç¾ï¼‰";
        if (/^\w+\s*=\s*\w+\s*\*\*\s*\d+/.test(s)) return "æ¬¡æ–¹ä¸¦æŒ‡æ´¾";
        if (/^plt\.plot\(/.test(s)) return "æŠ˜ç·š/æ¨™è¨˜ï¼›å¯å«æ¨£å¼èˆ‡ label";
        if (/^plt\.scatter\(/.test(s)) return "æ•£é»åœ–";
        if (/^plt\.hist\(/.test(s)) return "ç›´æ–¹åœ–";
        if (/^plt\.imshow\(/.test(s)) return "é¡¯ç¤ºå½±åƒé™£åˆ—";
        if (/^plt\.title\(/.test(s)) return "åœ–è¡¨æ¨™é¡Œ";
        if (/^plt\.xlabel\(/.test(s)) return "x è»¸æ¨™ç±¤";
        if (/^plt\.ylabel\(/.test(s)) return "y è»¸æ¨™ç±¤";
        if (/^plt\.grid\(/.test(s)) return "é¡¯ç¤ºæ ¼ç·š";
        if (/^plt\.legend\(/.test(s)) return "é¡¯ç¤ºåœ–ä¾‹";
        if (/^plt\.yscale\(/.test(s)) return "åˆ‡æ› y è»¸æ¯”ä¾‹";
        if (/^plt\.minorticks_on\(/.test(s)) return "å•Ÿç”¨æ¬¡åˆ»åº¦";
        if (/^plt\.axis\(/.test(s)) return "è¦–çª—ç¯„åœ/æ¯”ä¾‹";
        if (/^plt\.savefig\(/.test(s)) return "è¼¸å‡ºåœ–æª”";
        if (/^plt\.show\(\)/.test(s)) return "é¡¯ç¤ºç›®å‰åœ–å½¢ï¼ˆé€™è£¡è¢«æ””æˆªä»¥å–å¾—å½±åƒï¼‰";
        if (/^\w+\s*=\s*plt\.figure\(/.test(s)) return "å»ºç«‹ Figure ç‰©ä»¶";
        if (/^plt\.figure\(/.test(s)) return "å»ºç«‹/åˆ‡æ› Figure";
        if (/^plt\.subplot2grid\(/.test(s)) return "è‡ªè¨‚ç¶²æ ¼å­åœ–";
        if (/^fig\.add_subplot\(/.test(s) && /projection=['"]polar['"]/.test(s)) return "åœ¨ Figure ä¸Šå»ºç«‹æ¥µåº§æ¨™ Axes";
        if (/^fig\.add_subplot\(/.test(s) && /projection=['"]3d['"]/.test(s)) return "åœ¨ Figure ä¸Šå»ºç«‹ 3D Axes";
        if (/^plt\.subplot\(/.test(s) && /projection='polar'/.test(s)) return "ï¼ˆå»ºè­°æ”¹ç”¨ fig.add_subplot(..., projection='polar')ï¼‰";
        if (/^plt\.subplot\(/.test(s) && /projection='3d'/.test(s)) return "ï¼ˆå»ºè­°æ”¹ç”¨ fig.add_subplot(..., projection='3d')ï¼‰";
        if (/^plt\.subplot\(/.test(s)) return "å»ºç«‹/åˆ‡æ›å­åœ–";
        if (/^fig,.*=\s*plt\.subplots\(/.test(s)) return "ç‰©ä»¶å°å‘ï¼šå»ºç«‹ Figure èˆ‡ Axes";
        if (/^ax\d*\.plot_surface\(/.test(s) || /^ax\.plot_surface\(/.test(s)) return "3D æ›²é¢";
        if (/^ax\d*\.plot\(/.test(s) || /^ax\.plot\(/.test(s)) return "åœ¨æŒ‡å®š Axes ä¸Šç¹ªç·š";
        if (/^ax\.set_xticks\(/.test(s)) return "è¨­å®š x ä¸»åˆ»åº¦";
        if (/^ax\.set_yticks\(/.test(s)) return "è¨­å®š y ä¸»åˆ»åº¦";
        if (/^ax\.set_xticklabels\(/.test(s)) return "è¨­å®š x åˆ»åº¦æ¨™ç±¤";
        if (/^ax\.set_yticklabels\(/.test(s)) return "è¨­å®š y åˆ»åº¦æ¨™ç±¤";
        if (/^ax\.tick_params\(/.test(s)) return "åˆ»åº¦æ¨£å¼";
        if (/^plt\.contourf\(/.test(s)) return "ç­‰é«˜ç·šå¡«è‰²";
        if (/^plt\.colorbar\(/.test(s)) return "åŠ å…¥è‰²æ¢";
        return "ä¸€èˆ¬ Python æŒ‡ä»¤";
      }
      const explainLine = (line) => {
        const parts = line.split(';').map(p => p.trim()).filter(Boolean);
        if (parts.length <= 1) return explainOne(line);
        return parts.map(explainOne).join("ï¼›");
      };
      function annotatePython(code){
        const lines = code.replace(/\r\n/g,'\n').split('\n');
        const maxLen = lines.reduce((m, s) => Math.max(m, s.replace(/\s+$/,'').length), 0);
        const col = Math.max(40, Math.min(88, maxLen + 2));
        return lines.map(raw => {
          const line = raw.replace(/\s+$/,'');
          if (!line.trim()) return raw;
          const pad = ' '.repeat(Math.max(1, col - line.length));
          return line + pad + '# ' + explainLine(line);
        }).join('\n');
      }

      /* ========= å…¨åŸŸåŸ·è¡Œç®¡ç†ï¼šå–®ä¸€åŸ·è¡Œ + å»£æ’­æ¸…ç©º ========= */
      const RunContext = createContext({
        register: (id, clearFn) => () => {},
        start: (id) => ({ runSeq: 0 }),
        done: (id, seq) => {},
        evictIfCurrent: (id) => {},
        getCurrent: () => null,
      });

      function RunProvider({ children }) {
        const currentRef = useRef(null);   // { id, seq }
        const seqRef = useRef(1);
        const registryRef = useRef(new Map()); // id -> clearFn

        const register = useCallback((id, clearFn) => {
          registryRef.current.set(id, clearFn);
          return () => { registryRef.current.delete(id); };
        }, []);

        const broadcastClearExcept = useCallback((keepId) => {
          registryRef.current.forEach((fn, id) => {
            if (id !== keepId) {
              try { fn(""); } catch (_) {}
            }
          });
        }, []);

        const start = useCallback((id) => {
          broadcastClearExcept(id); // æ¸…æ‰å…¶ä»–å¡ç‰‡è¼¸å‡º
          const seq = seqRef.current++;
          currentRef.current = { id, seq };
          return { runSeq: seq };
        }, [broadcastClearExcept]);

        const done = useCallback((id, seq) => {
          const cur = currentRef.current;
          if (cur && cur.id === id && cur.seq === seq) currentRef.current = null;
        }, []);

        const evictIfCurrent = useCallback((id) => {
          const cur = currentRef.current;
          if (cur && cur.id === id) currentRef.current = null;
        }, []);

        const getCurrent = useCallback(() => currentRef.current, []);

        const ctx = useMemo(() => ({ register, start, done, evictIfCurrent, getCurrent }), [register, start, done, evictIfCurrent, getCurrent]);
        return <RunContext.Provider value={ctx}>{children}</RunContext.Provider>;
      }

      /* ========= Pyodide Workerï¼ˆé è¼‰ polar/3d æŠ•å½± + OOP å‹å–„ï¼‰ ========= */
      function makeWorkerURL(){
        const src = `
          let ready = false;
          let pyodide = null;

          self.addEventListener('message', async (e) => {
            const { type, code } = e.data || {};
            try {
              if (type === 'init') {
                if (!pyodide) {
                  importScripts('https://cdn.jsdelivr.net/pyodide/v0.25.1/full/pyodide.js');
                  pyodide = await loadPyodide({ indexURL: 'https://cdn.jsdelivr.net/pyodide/v0.25.1/full/' });
                  await pyodide.loadPackage(['numpy','matplotlib']);
                  await pyodide.runPythonAsync(\`
import matplotlib
matplotlib.use("agg")
from matplotlib import rcParams
rcParams['font.family'] = ['DejaVu Sans']
rcParams['axes.unicode_minus'] = True

import matplotlib.pyplot as plt
import numpy as np
import io, base64, gc

# ---- é å…ˆè¨»å†ŠæŠ•å½±ï¼ˆé¿å…å»¶é²è¼‰å…¥å¤±æ•—ï¼‰ ----
try:
    from mpl_toolkits.mplot3d import Axes3D  # noqa: F401
except Exception:
    pass
try:
    from matplotlib.projections import get_projection_class
    _ = get_projection_class('polar')
    _ = get_projection_class('3d')
except Exception:
    pass

def _encode_fig(fig):
    bio = io.BytesIO()
    fig.savefig(bio, format='png', bbox_inches='tight', dpi=96)
    return "data:image/png;base64," + base64.b64encode(bio.getvalue()).decode()

def _capture_all_open_figs(images):
    try:
        fignums = list(plt.get_fignums())
    except Exception:
        fignums = []
    for num in fignums:
        try:
            fig = plt.figure(num)
            images.append(_encode_fig(fig))
        except Exception:
            pass
    for num in fignums:
        try:
            plt.close(num)
        except Exception:
            pass

def _run_matplotlib_user_code(code: str):
    import matplotlib.image as mpimg
    images = []
    plt.close('all')
    _orig_show = plt.show
    def _show_hook(*args, **kwargs):
        _capture_all_open_figs(images)
    try:
        plt.show = _show_hook
        ns = {}
        exec(code, {'np':np, 'plt':plt, 'mpimg':mpimg}, ns)
    finally:
        _capture_all_open_figs(images)
        plt.show = _orig_show
    gc.collect()
    return images
                  \`);
                }
                ready = true;
                self.postMessage({ type:'ready' });
              } else if (type === 'run') {
                if (!ready) { self.postMessage({ type:'error', error:'Python not ready' }); return; }
                pyodide.globals.set("CODE_TO_RUN", code);
                await pyodide.runPythonAsync(\`_RET = _run_matplotlib_user_code(CODE_TO_RUN)\`);
                const images = pyodide.globals.get("_RET").toJs({ create_proxies:false });
                pyodide.globals.delete("CODE_TO_RUN");
                pyodide.globals.delete("_RET");
                self.postMessage({ type:'result', images });
              }
            } catch (err) {
              self.postMessage({ type:'error', error: String(err && err.message ? err.message : err) });
            }
          });
        `;
        const blob = new Blob([src], { type:'application/javascript' });
        return URL.createObjectURL(blob);
      }

      const PyContext = createContext({ ready:false, loading:true, error:null, busy:false, run: async () => { throw new Error('not ready'); } });

      function PyProvider({ children }) {
        const [state, setState] = useState({ ready:false, loading:true, error:null, busy:false });
        const workerRef = useRef(null);
        const timeoutRef = useRef(null);
        const queueRef = useRef(Promise.resolve());
        const runCountRef = useRef(0);

        const initWorker = useCallback(() => {
          if (workerRef.current) {
            try { workerRef.current.terminate(); } catch(_) {}
            workerRef.current = null;
          }
          const url = makeWorkerURL();
          const w = new Worker(url);
          URL.revokeObjectURL(url);
          workerRef.current = w;

          w.onmessage = (e) => {
            const { type } = e.data || {};
            if (type === 'ready') {
              setState(s => ({ ...s, ready:true, loading:false, error:null }));
            } else if (type === 'result') {
              clearTimeout(timeoutRef.current);
              setState(s => ({ ...s, busy:false }));
              if (pendingResolveRef.current) pendingResolveRef.current(e.data.images);
              pendingResolveRef.current = null;
            } else if (type === 'error') {
              clearTimeout(timeoutRef.current);
              setState(s => ({ ...s, busy:false, error: e.data.error || 'åŸ·è¡ŒéŒ¯èª¤' }));
              if (pendingRejectRef.current) pendingRejectRef.current(new Error(e.data.error || 'åŸ·è¡ŒéŒ¯èª¤'));
              pendingRejectRef.current = null;
            }
          };
          w.onerror = (err) => {
            clearTimeout(timeoutRef.current);
            setState(s => ({ ...s, busy:false, error: String(err.message || err) }));
            if (pendingRejectRef.current) pendingRejectRef.current(new Error(String(err.message || err)));
            pendingRejectRef.current = null;
          };

          // å•Ÿå‹•
          w.postMessage({ type:'init' });
          setState({ ready:false, loading:true, error:null, busy:false });
        }, []);

        // å•Ÿå‹•ä¸€æ¬¡
        useEffect(() => {
          initWorker();
          return () => { if (workerRef.current) workerRef.current.terminate(); };
        }, [initWorker]);

        const TIMEOUT_MS = 12000;
        const pendingResolveRef = useRef(null);
        const pendingRejectRef = useRef(null);

        const run = useCallback(async (code) => {
          // ä½‡åˆ—åŒ–ï¼ˆä¸€æ¬¡åªè·‘ä¸€æ®µï¼‰ï¼Œä¸¦åŠ å…¥é€¾æ™‚ä¿è­·
          const task = () => new Promise((resolve, reject) => {
            if (!workerRef.current) return reject(new Error("Python å¼•æ“ä¸å­˜åœ¨"));
            pendingResolveRef.current = resolve;
            pendingRejectRef.current = reject;
            setState(s => ({ ...s, busy:true, error:null }));
            workerRef.current.postMessage({ type:'run', code });
            clearTimeout(timeoutRef.current);
            timeoutRef.current = setTimeout(() => {
              // å¼·åˆ¶é‡å•Ÿ worker
              try { workerRef.current.terminate(); } catch(_) {}
              workerRef.current = null;
              setState(s => ({ ...s, busy:false, ready:false, error: "åŸ·è¡Œé€¾æ™‚ï¼Œå·²é‡å•Ÿ Python å¼•æ“" }));
              // ç«‹å³é‡å»ºä»¥ä¾¿ä¸‹æ¬¡å¯ç”¨
              initWorker();
              reject(new Error("åŸ·è¡Œé€¾æ™‚ï¼Œå·²é‡å•Ÿ Python å¼•æ“"));
            }, TIMEOUT_MS);
          });

          const p = queueRef.current.then(task);
          // ç¶­è­·ä½‡åˆ—å°¾ç«¯ï¼ˆåæ‰éŒ¯èª¤ï¼Œé¿å…éˆæ–·è£‚ï¼‰
          queueRef.current = p.catch(() => {});
          const images = await p;

          // å®šæœŸé‡å•Ÿï¼šè·‘äº† 5 æ¬¡è‡ªå‹•åˆ·æ–° workerï¼Œé¿å…é•·æ™‚ä½¿ç”¨å †ç©
          runCountRef.current = (runCountRef.current + 1) % 5;
          if (runCountRef.current === 0) {
            try { workerRef.current.terminate(); } catch(_) {}
            workerRef.current = null;
            initWorker();
          }
          return images;
        }, [initWorker]);

        const ctx = useMemo(() => ({ ...state, run }), [state, run]);
        return <PyContext.Provider value={ctx}>{children}</PyContext.Provider>;
      }

      /* ========= UI å…ƒä»¶ ========= */
      function Dropdown({ label, items }) {
        const [open, setOpen] = useState(false);
        const ref = useRef(null);
        useEffect(() => {
          const onDoc = (e) => { if (ref.current && !ref.current.contains(e.target)) setOpen(false); };
          document.addEventListener("click", onDoc);
          return () => document.removeEventListener("click", onDoc);
        }, []);
        return (
          <div className="relative" ref={ref}>
            <button className="px-3 py-2 rounded-xl hover:bg-zinc-800/60 transition border border-zinc-700" onClick={() => setOpen(v => !v)}>{label}</button>
            {open && (<div className="absolute mt-2 min-w-56 rounded-xl border border-zinc-700 bg-zinc-900/95 backdrop-blur p-2 shadow-2xl z-50">{items}</div>)}
          </div>
        );
      }
      function Accordion({ items }) {
        const [openIdx, setOpenIdx] = useState(null);
        return (
          <div className="space-y-3">
            {items.map((it, i) => (
              <div key={i} className="rounded-2xl border border-zinc-700 overflow-hidden">
                <button className="w-full text-left px-4 py-3 bg-zinc-800/60 hover:bg-zinc-800/80" onClick={() => setOpenIdx(openIdx === i ? null : i)}>
                  <div className="font-medium">{it.header}</div>
                  {it.sub && (<div className="text-xs text-zinc-400 mt-0.5">{it.sub}</div>)}
                </button>
                {openIdx === i && (<div className="px-4 py-4 bg-zinc-900/70 border-t border-zinc-700">{it.content}</div>)}
              </div>
            ))}
          </div>
        );
      }

      /* ========= CodeBlock ========= */
      function CodeBlock({ code }) {
        const idRef = useRef(genCbId());
        const codeRef = useRef(null);
        const runTokenRef = useRef(0);

        const [copyState, setCopyState] = useState("idle");
        const [annotate, setAnnotate] = useState(false);
        const [runState, setRunState] = useState({ running:false, imgs:[], err:null });

        const py = useContext(PyContext);
        const runMgr = useContext(RunContext);

        const clearNow = useCallback(() => {
          runTokenRef.current++;
          setRunState({ running:false, imgs:[], err:null });
        }, []);
        // è¨»å†Šï¼‹ç¢ºä¿å¸è¼‰æ™‚åè¨»å†Šï¼ˆä¿®æ­£è¨˜æ†¶é«”å¤–æ´©ï¼‰
        useEffect(() => {
          return runMgr.register(idRef.current, clearNow);
        }, [runMgr, clearNow]);

        useEffect(() => { clearNow(); setAnnotate(false); }, [code]);

        const displayed = annotate ? annotatePython(code) : code;

        const onCopy = async () => {
          const txt = codeRef.current?.innerText ?? displayed;
          let ok = false;
          try { if (window.isSecureContext && navigator.clipboard?.writeText) { await navigator.clipboard.writeText(txt); ok = true; } } catch (_) {}
          if (!ok) {
            try { const ta=document.createElement("textarea"); ta.value=txt; ta.setAttribute("readonly",""); ta.style.position="fixed"; ta.style.top="-1000px"; document.body.appendChild(ta); ta.focus(); ta.select(); ok=document.execCommand("copy"); document.body.removeChild(ta); } catch(_) { ok=false; }
          }
          if (!ok && codeRef.current) { const sel=window.getSelection(); if (sel) { sel.removeAllRanges(); const range=document.createRange(); range.selectNodeContents(codeRef.current); sel.addRange(range); } }
          setCopyState(ok?"ok":"fail"); setTimeout(()=>setCopyState("idle"),2000);
        };

        const onRun = async () => {
          const { runSeq } = runMgr.start(idRef.current); // å»£æ’­æ¸…ç©ºå…¶ä»–å¡ç‰‡
          const token = ++runTokenRef.current;
          setRunState({ running:true, imgs:[], err:null });
          try {
            const imgs = await py.run(code); // Worker ä½‡åˆ— + é€¾æ™‚ä¿è­·
            if (token !== runTokenRef.current) return;
            setRunState({ running:false, imgs, err:null });
          } catch (e) {
            if (token !== runTokenRef.current) return;
            setRunState({ running:false, imgs:[], err:String(e && e.message ? e.message : e) });
          } finally {
            runMgr.done(idRef.current, runSeq);
          }
        };

        const onClear = () => {
          clearNow();
          runMgr.evictIfCurrent(idRef.current);
        };

        return (
          <div className="grid md:grid-cols-2 gap-3">
            <div className="border border-zinc-700 rounded-xl overflow-hidden">
              <div className="flex items-center gap-2 justify-between px-3 py-2 bg-zinc-800/60 border-b border-zinc-700">
                <span className="text-xs uppercase tracking-wider text-zinc-400">Python / Matplotlib</span>
                <div className="flex items-center gap-2">
                  <button className={`text-sm px-2 py-1 rounded-lg ${annotate?"bg-emerald-700":"bg-zinc-700 hover:bg-zinc-600"}`} onClick={() => setAnnotate(v=>!v)}>è¨»è§£ï¼š{annotate?"é–‹":"é—œ"}</button>
                  <button className={`text-sm px-2 py-1 rounded-lg ${runState.running ? "bg-zinc-700" : "bg-emerald-700 hover:bg-emerald-600"}`}
                          disabled={runState.running}
                          onClick={onRun}>
                    {runState.running ? "åŸ·è¡Œä¸­â€¦" : "åŸ·è¡Œï¼ˆPythonï¼‰"}
                  </button>
                  <button className="text-sm px-2 py-1 rounded-lg bg-zinc-700 hover:bg-zinc-600" onClick={onClear}>æ¸…ç©ºè¼¸å‡º</button>
                  <button className={`text-sm px-2 py-1 rounded-lg ${copyState==="ok"?"bg-emerald-700":copyState==="fail"?"bg-amber-700":"bg-zinc-700 hover:bg-zinc-600"}`} onClick={onCopy}>è¤‡è£½ï¼ˆç›®å‰é¡¯ç¤ºï¼‰</button>
                </div>
              </div>
              <pre className="p-3 text-sm overflow-auto" ref={codeRef}><code>{displayed}</code></pre>
              {copyState==="fail" && <div className="px-3 pb-3 text-xs text-amber-400">ç„¡æ³•ç›´æ¥å¯«å…¥å‰ªè²¼ç°¿ï¼šå·²é¸å–æ–‡å­—ï¼Œè«‹æŒ‰ Ctrl/Cmd + Cã€‚</div>}
            </div>

            <div className="border border-zinc-700 rounded-xl overflow-hidden">
              <div className="px-3 py-2 bg-zinc-800/60 border-b border-zinc-700 text-xs uppercase tracking-wider text-zinc-400">å³æ™‚è¼¸å‡º</div>
              <div className="p-3">
                {runState.err && <div className="text-amber-400 text-sm whitespace-pre-wrap">éŒ¯èª¤ï¼š{runState.err}</div>}
                {runState.running && <div className="text-zinc-400 text-sm mb-2">åŸ·è¡Œä¸­â€¦</div>}
                {!runState.running && runState.imgs.length === 0 && !runState.err && (
                  <div className="text-zinc-500 text-sm">å°šæœªåŸ·è¡Œã€‚</div>
                )}
                <div className="grid gap-3">
                  {runState.imgs.map((src, i) => (
                    <div key={i} className="rounded-lg overflow-hidden border border-zinc-800 bg-zinc-900/30">
                      <img src={src} alt={`matplotlib-output-${i}`} className="w-full h-auto block"/>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          </div>
        );
      }

      /* ========= ç¯„ä¾‹è³‡æ–™ï¼ˆå…¨é¢æ”¹ç‚º OOP æŠ•å½±ï¼‰ ========= */
      const DEMOS = [
        {
          id: "demo-first-plot",
          title: "ç¬¬ä¸€å¼µåœ–ï¼šå¹³æ–¹å‡½æ•¸",
          goal: "ä½¿ç”¨ NumPy ç”¢ç”Ÿ x èˆ‡ y=x**2ï¼Œç•«ç·šä¸¦åŠ åŸºæœ¬æ¨™è¨»ã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-2, 2, 5)
y = x**2

plt.plot(x, y)
plt.title("Square function")
plt.xlabel("x")
plt.ylabel("y = x**2")
plt.grid(True)
plt.show()`
        },
        {
          id: "demo-styles",
          title: "ç·šæ¢æ¨£å¼èˆ‡å¤šåœ–ä¾‹",
          goal: "ä¸€æ¬¡ç•«ä¸‰æ¢æ›²ç·šï¼Œå±•ç¤ºé¡è‰²/ç·šå‹/é»å‹èˆ‡ legendã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-1.4, 1.4, 7)
plt.plot(x, x, 'g--', label='y=x')
plt.plot(x, x**2, 'r:', label='y=x^2')
plt.plot(x, x**3, 'b^', label='y=x^3')
plt.legend(loc='best')
plt.grid(True)
plt.title("Multiple styles")
plt.show()`
        },
        {
          id: "demo-subplots",
          title: "å­åœ–ä½ˆå±€ï¼š2Ã—2 èˆ‡è·¨æ¬„",
          goal: "ç¤ºç¯„ subplot èˆ‡ subplot2grid çš„å·®ç•°èˆ‡è·¨æ¬„ç”¨æ³•ã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-1.4, 1.4, 30)
plt.subplot(2,2,1); plt.plot(x, x); plt.title("Linear")
plt.subplot(2,2,2); plt.plot(x, x**2); plt.title("Square")
plt.subplot(2,2,3); plt.plot(x, x**3); plt.title("Cube")
plt.subplot(2,2,4); plt.plot(x, x**4); plt.title("Fourth power")
plt.suptitle("subplot(2,2,*)")
plt.show()

# grid layout with spans
plt.subplot2grid((3,3), (0, 0), rowspan=2, colspan=2); plt.plot(x, x**2); plt.title("2x2 span")
plt.subplot2grid((3,3), (0, 2)); plt.plot(x, x**3); plt.title("Top-right")
plt.subplot2grid((3,3), (1, 2), rowspan=2); plt.plot(x, x**4); plt.title("Right column")
plt.subplot2grid((3,3), (2, 0), colspan=2); plt.plot(x, x**5); plt.title("Bottom span")
plt.suptitle("subplot2grid example")
plt.show()`
        },
        {
          id: "demo-oop",
          title: "ç‰©ä»¶å°å‘å¯«æ³•ï¼šsubplots()",
          goal: "ä½¿ç”¨ fig, ax = plt.subplots() æ˜ç¢ºå–å¾— Figure èˆ‡ Axesã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(-2, 2, 200)
fig, (ax1, ax2) = plt.subplots(2,1, sharex=True, figsize=(6,4))
ax1.plot(x, np.sin(3*x**2), "r-", label="sin(3x^2)")
ax1.plot(x, np.cos(5*x**2), "b-", label="cos(5x^2)")
ax1.legend(); ax1.grid(True); ax1.set_title("Top")
ax2.plot(x, np.sin(3*x), "g-"); ax2.grid(True); ax2.set_title("Bottom")
fig.suptitle("Object-oriented style")
plt.show()`
        },
        {
          id: "demo-scales-ticks",
          title: "åæ¨™æ¯”ä¾‹èˆ‡åˆ»åº¦",
          goal: "å±•ç¤º linear/log/symlog èˆ‡æ‰‹å‹•åˆ»åº¦ã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

x = np.linspace(0.1, 15, 200)
y = x**3/np.exp(2*x)

plt.figure(1); plt.plot(x,y); plt.yscale('linear'); plt.title('linear'); plt.grid(True)
plt.figure(2); plt.plot(x,y); plt.yscale('log');    plt.title('log');    plt.grid(True)
plt.figure(3); plt.plot(x,y); plt.yscale('symlog', linthresh=0.05); plt.title('symlog'); plt.grid(True)

# manual ticks
x2 = np.linspace(-2, 2, 100)
ax = plt.figure(4).gca()
ax.plot(x2, x2**3)
ax.set_xticks(np.arange(-2, 3, 1))
ax.set_yticks(np.arange(-8, 9, 2))
plt.title("manual ticks")
plt.grid(True)
plt.show()`
        },
        {
          id: "demo-polar-3d",
          title: "æ¥µåº§æ¨™èˆ‡ 3D æ›²é¢ï¼ˆOOPï¼‰",
          goal: "ä½¿ç”¨ OOP æ˜ç¢ºå»ºç«‹æŠ•å½±ï¼Œé¿å…éš±å¼ç‹€æ…‹å•é¡Œã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt

# Polar (OOP)
theta = np.linspace(0, 2*np.pi, 400)
fig = plt.figure()
ax = fig.add_subplot(1, 1, 1, projection='polar')
ax.plot(theta, 0.5*np.cos(5*theta))
ax.set_title("Polar curve")
plt.show()

# 3D surface (OOP)
x = np.linspace(-5,5,50); y = np.linspace(-5,5,50)
X, Y = np.meshgrid(x, y); R = np.sqrt(X**2 + Y**2); Z = np.sin(R)
fig = plt.figure()
ax = fig.add_subplot(1, 1, 1, projection='3d')
ax.plot_surface(X, Y, Z, rstride=1, cstride=1, linewidth=0.1)
ax.set_title("3D surface")
plt.show()`
        },
        {
          id: "demo-scatter-hist-img",
          title: "æ•£é» / ç›´æ–¹åœ– / é¡¯ç¤ºå½±åƒ",
          goal: "å¸¸è¦‹è³‡æ–™åœ–å½¢åŒ–ã€‚",
          code: `import numpy as np
import matplotlib.pyplot as plt
import matplotlib.image as mpimg

np.random.seed(42)
x, y = np.random.rand(2, 100)
plt.scatter(x, y, s=50, alpha=0.6); plt.grid(True); plt.title("scatter")
plt.show()

data = np.random.randn(400)
plt.hist(data, bins=20, rwidth=0.9); plt.title("hist"); plt.grid(True)
plt.show()

# image: use fallback if file missing
try:
    img = mpimg.imread("my_image.png")
except Exception:
    u = np.linspace(0, 1, 128); v = np.linspace(0, 1, 128)
    U, V = np.meshgrid(u, v)
    img = 0.5 + 0.5*np.sin(10*U)*np.cos(10*V)
plt.imshow(img, cmap="viridis"); plt.axis('off'); plt.title("image")
plt.show()`
        }
      ];

      const USE_CASES = [
        {
          id: "basics",
          title: "å¿«é€Ÿä¸Šæ‰‹ï¼šç¬¬ä¸€å¼µåœ–",
          brief: "å…ˆç”¨ plt.plot() ç•«å‡ºè³‡æ–™ï¼Œå†ç”¨ plt.show() é¡¯ç¤ºï¼›åŠ ä¸Šæ¨™é¡Œ/åº§æ¨™/æ ¼ç·šæå‡å¯è®€æ€§ã€‚",
          bullets: ["plt.plot(x, y) ç•«ç·šï¼›è‹¥åªæœ‰ yï¼Œx æœƒç”¨ 0..N-1", "plt.title / xlabel / ylabel / grid å¢å¼·å¯è®€æ€§", "plt.axis([xmin,xmax,ymin,ymax]) æ§åˆ¶è¦–çª—"],
          functions: ["plt.plot","plt.show","plt.title","plt.xlabel","plt.ylabel","plt.grid","plt.axis"],
          quick: `import matplotlib.pyplot as plt
plt.plot([1,2,3])
plt.title("Quick example")
plt.show()`
        },
        {
          id: "style",
          title: "æ¨£å¼èˆ‡å¤šæ¢æ›²ç·š",
          brief: "é¡è‰²ã€ç·šå‹ã€é»æ¨£å¼å¯åœ¨ç¬¬ä¸‰åƒæ•¸ fmt è¨­å®šï¼›å¤šæ¢ç·šå¯å¤šæ¬¡å‘¼å« plotã€‚",
          bullets: ['fmt ä¾‹ï¼š"g--"=ç¶ è‰²è™›ç·šã€"r:"=ç´…è‰²é»ç·šã€"b^"=è—è‰²ä¸‰è§’å½¢', "å›å‚³ Line2Dï¼Œå¯å† set_alpha/set_linewidth", "legend æ­é… label é¡¯ç¤ºåœ–ä¾‹"],
          functions: ["plt.plot","plt.legend"],
          quick: `import numpy as np
import matplotlib.pyplot as plt
x = np.linspace(-1,1,10)
plt.plot(x, x**2, label='square')
plt.plot(x, x**3, label='cube')
plt.legend(); plt.grid(True); plt.title("Legend & grid")
plt.show()`
        }
      ];

      /* ========= å‡½å¼æ¸…å–®ï¼ˆæŠ•å½±ä¾‹å­å…¨éƒ¨ OOPï¼‰ ========= */
      const FUNCTIONS = [
        {
          id: "cat-01-basics",
          title: "â‘  åŸºç¤ç¹ªåœ–èˆ‡æ¨™è¨»ï¼ˆå¸¸ç”¨å‡½å¼ï¼‰",
          items: [
            { name: "plt.plot([x], y, [fmt], ...)", desc: "ç•«ç·š/é»ï¼›fmt æ§åˆ¶é¡è‰²/ç·šå‹/é»å‹ã€‚", what: "æœ€å¸¸ç”¨çš„ç¹ªåœ–å‡½å¼ã€‚", uses: ["å‡½æ•¸å¯è¦–åŒ–","æ™‚é–“åºåˆ—è¶¨å‹¢"], code: `import numpy as np
import matplotlib.pyplot as plt
x = np.linspace(-2,2,5)
plt.plot(x, x**2, 'g--')
plt.title("Title")
plt.show()` },
            { name: "plt.legend(loc='best')", desc: "åœ–ä¾‹ï¼ˆéœ€å…ˆåœ¨ plot æ™‚çµ¦ labelï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
x = np.linspace(-1,1,10)
plt.plot(x,x**2,label='square')
plt.plot(x,x**3,label='cube')
plt.legend(loc='best'); plt.grid(True); plt.title("Legend")
plt.show()` },
            { name: "plt.savefig(path, ...)", desc: "è¼¸å‡ºåœ–æª”ã€‚", uses: ["å ±å‘Š/ç¶²é è¼¸å‡º"], code: `import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(-1,1,50)
plt.plot(x,x**2)
plt.title("Saved figure")
plt.savefig('square.png', transparent=True)
plt.show()` },
          ]
        },
        {
          id: "cat-02-layout",
          title: "â‘¡ å­åœ–èˆ‡å¤šåœ–ï¼ˆç‰©ä»¶å°å‘/ç‰ˆé¢é…ç½®ï¼‰",
          items: [
            { name: "plt.subplot(r,c,i)", desc: "åœ¨ rÃ—c ç¶²æ ¼ä¸­é¸ç¬¬ i å€‹å­åœ–ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
x = np.linspace(-1,1,30)
plt.subplot(221); plt.plot(x,x); plt.title("Linear")
plt.subplot(222); plt.plot(x,x**2); plt.title("Square")
plt.subplot(223); plt.plot(x,x**3); plt.title("Cube")
plt.subplot(224); plt.plot(x,x**4); plt.title("Fourth")
plt.show()` },
            { name: "plt.subplots(nrows, ncols, ...)", desc: "ç‰©ä»¶å°å‘å¯«æ³•ï¼šå›å‚³ figure èˆ‡ axesï¼ˆé™£åˆ—ï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(-2,2,200)
fig,(ax1,ax2)=plt.subplots(2,1,sharex=True)
ax1.plot(x,np.sin(3*x**2)); ax1.grid(True); ax1.set_title("Top")
ax2.plot(x,np.cos(5*x**2)); ax2.grid(True); ax2.set_title("Bottom")
fig.suptitle('Object-oriented subplots')
plt.show()` },
          ]
        },
        {
          id: "cat-03-special",
          title: "â‘¢ ç‰¹æ®ŠæŠ•å½±èˆ‡ 3D",
          items: [
            { name: "fig.add_subplot(..., projection='polar')", desc: "æ¥µåº§æ¨™ç¹ªåœ–ï¼ˆOOPï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
theta=np.linspace(0,2*np.pi,400)
fig = plt.figure()
ax = fig.add_subplot(1,1,1, projection='polar')
ax.plot(theta, 0.5*np.cos(5*theta))
ax.set_title("Polar")
plt.show()` },
            { name: "fig.add_subplot(..., projection='3d') + ax.plot_surface()", desc: "3D æ›²é¢ï¼ˆOOPï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(-5,5,50); y=np.linspace(-5,5,50)
X,Y=np.meshgrid(x,y); Z=np.sin(np.sqrt(X**2+Y**2))
fig = plt.figure()
ax = fig.add_subplot(1,1,1, projection='3d')
ax.plot_surface(X,Y,Z,linewidth=0.1)
ax.set_title("3D surface")
plt.show()` },
            { name: "plt.contourf() + plt.colorbar()", desc: "ç­‰é«˜ç·šå¡«è‰² + è‰²æ¢ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
x=np.linspace(-5,5,50); y=np.linspace(-5,5,50)
X,Y=np.meshgrid(x,y); Z=np.sin(np.sqrt(X**2+Y**2))
plt.contourf(X,Y,Z,levels=20)
plt.colorbar(); plt.title("Contourf")
plt.show()` },
          ]
        },
        {
          id: "cat-04-scatter-hist-image",
          title: "â‘£ æ•£é» / ç›´æ–¹ / å½±åƒ",
          items: [
            { name: "plt.scatter(x, y, s=..., c=..., alpha=...)", desc: "æ•£é»åœ–ï¼ˆå¤§å°/é¡è‰²/é€æ˜åº¦ï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
np.random.seed(0)
x,y=np.random.rand(2,100)
plt.scatter(x,y,s=80,alpha=0.5)
plt.title("Scatter")
plt.grid(True); plt.show()` },
            { name: "plt.hist(data, bins=...)", desc: "ç›´æ–¹åœ–ï¼ˆbins å¯ç‚ºæ•¸é‡æˆ–é‚Šç•Œé™£åˆ—ï¼‰ã€‚", code: `import numpy as np
import matplotlib.pyplot as plt
data=np.random.randn(500)
plt.hist(data,bins=20,rwidth=0.9)
plt.title("Histogram")
plt.grid(True); plt.show()` },
            { name: "mpimg.imread() / plt.imshow()", desc: "è®€åœ–èˆ‡é¡¯ç¤ºï¼ˆç„¡æª”æ¡ˆè‡ªé€ å½±åƒï¼‰ã€‚", code: `import matplotlib.image as mpimg
import matplotlib.pyplot as plt
import numpy as np
try:
    img = mpimg.imread('your.png')
except Exception:
    t = np.linspace(0,1,256)
    X, Y = np.meshgrid(t, t)
    img = 0.5 + 0.5*np.sin(12*X)*np.cos(9*Y)
plt.imshow(img); plt.axis('off'); plt.title('Image')
plt.show()` },
          ]
        }
      ];

      /* ========= é é¢éª¨æ¶ ========= */
      function Breadcrumbs({ trail }) {
        return (
          <nav className="text-sm text-zinc-400">
            {trail.map((t, i) => (
              <span key={i}>
                <span className={"" + (i === trail.length - 1 ? " text-zinc-200" : " hover:text-zinc-200 cursor-pointer")}>{t.label}</span>
                {i < trail.length - 1 && <span className="mx-2">â€º</span>}
              </span>
            ))}
          </nav>
        );
      }

      function Header({ section, setSection }) {
        return (
          <header className="sticky top-0 z-40 border-b border-zinc-800 backdrop-blur bg-zinc-950/80">
            <div className="max-w-7xl mx-auto px-4 py-3 flex items-center gap-3">
              <div className="flex items-center gap-2 font-semibold text-lg"><span className="inline-block size-2 rounded-full bg-emerald-400" />Matplotlib æ‡¶äººåŒ…</div>
              <div className="ml-auto flex items-center gap-2">
                <button className={`px-3 py-2 rounded-xl hover:bg-zinc-800/60 transition ${section==="home"?"border border-zinc-700 bg-zinc-800/40":""}`} onClick={() => { setSection("home"); }}>é¦–é </button>
                <Dropdown label="ç”¨é€”" items={<div className="grid grid-cols-1 gap-1">{USE_CASES.map((u)=>(<button key={u.id} className="text-left px-3 py-2 rounded-lg hover:bg-zinc-800/70" onClick={() => { setSection("uses"); window.location.hash = `#/uses/${u.id}`; }}>{u.title}</button>))}</div>} />
                <Dropdown label="å‡½å¼/å°ˆæ¡ˆæ¼”ç¤º" items={<div className="grid grid-cols-1 gap-1">{DEMOS.map((d)=>(<button key={d.id} className="text-left px-3 py-2 rounded-lg hover:bg-zinc-800/70" onClick={() => { setSection("demos"); window.location.hash = `#/demos/${d.id}`; }}>{d.title}</button>))}</div>} />
                <Dropdown label="å‡½å¼ç´°ç¯€èˆ‡ç¯„ä¾‹" items={<div className="grid grid-cols-1 gap-1 max-h-80 overflow-auto pr-1">{FUNCTIONS.map((c)=>(<button key={c.id} className="text-left px-3 py-2 rounded-lg hover:bg-zinc-800/70" onClick={() => { setSection("funcs"); window.location.hash = `#/funcs/${c.id}`; }}>{c.title}</button>))}</div>} />
              </div>
            </div>
          </header>
        );
      }

      function Home({ setSection }) {
        return (
          <section className="space-y-8">
            <div className="grid md:grid-cols-2 gap-6 items-center">
              <div className="space-y-4">
                <h1 className="text-3å¤š font-semibold leading-tight">Matplotlib æ‡¶äººåŒ…</h1>
                <p className="text-zinc-300">äº’å‹•å¼æ•™å­¸èˆ‡æŸ¥è©¢ï¼šåœ¨ç€è¦½å™¨ç›´æ¥åŸ·è¡Œç¯„ä¾‹ã€æ”¯æ´æ¯è¡Œè¨»è§£ã€å–®ä¸€åŸ·è¡Œèˆ‡è‡ªå‹•æ¸…é™¤è¼¸å‡ºã€‚</p>
                <div className="flex flex-wrap gap-3">
                  <button className="px-4 py-2 rounded-xl bg-emerald-500/20 border border-emerald-500 hover:bg-emerald-500/30" onClick={() => setSection("uses")}>ç”±ç”¨é€”é–‹å§‹</button>
                  <button className="px-4 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700" onClick={() => setSection("demos")}>çœ‹æ¼”ç¤º</button>
                  <button className="px-4 py-2 rounded-xl bg-zinc-800 border border-zinc-700 hover:bg-zinc-700" onClick={() => setSection("funcs")}>æŸ¥å‡½å¼</button>
                </div>
              </div>
              <div className="rounded-2xl border border-zinc-800 bg-gradient-to-br from-zinc-900 to-zinc-950 p-6">
                <ol className="space-y-3 text-zinc-300">
                  <li>â‘  <b>ç”¨é€”</b>ï¼šä»»å‹™å°å‘ç¯„ä¾‹ã€‚</li>
                  <li>â‘¡ <b>å‡½å¼/å°ˆæ¡ˆæ¼”ç¤º</b>ï¼šå¯ç›´æ¥åŸ·è¡Œã€å³æ™‚å‡ºåœ–ã€‚</li>
                  <li>â‘¢ <b>å‡½å¼ç´°ç¯€</b>ï¼šå¸¸ç”¨å‡½å¼èˆ‡æœ€å°å¯è¡Œç¯„ä¾‹ã€‚</li>
                </ol>
              </div>
            </div>
          </section>
        );
      }

      function Uses({ sub, setSub, onGotoFunc }) {
        const current = USE_CASES.find((u) => u.id === sub) || USE_CASES[0];
        return (
          <section className="grid lg:grid-cols-[260px,1fr] gap-6">
            <aside className="space-y-2">
              <div className="text-xs uppercase tracking-wider text-zinc-400 mb-2">ç”¨é€”åˆ—è¡¨</div>
              <div className="space-y-1">
                {USE_CASES.map((u) => (
                  <button key={u.id} onClick={() => setSub(u.id)} className={`w	full text-left px-3 py-2 rounded-xl border ${current.id===u.id?"border-emerald-600 bg-emerald-500/10":"border-zinc-700 hover:bg-zinc-800/60"}`}>{u.title}</button>
                ))}
              </div>
            </aside>
            <div className="space-y-6">
              <header className="space-y-2">
                <h2 className="text-2xl font-semibold">{current.title}</h2>
                <p className="text-zinc-300">{current.brief}</p>
              </header>
              <div className="grid md:grid-cols-2 gap-4">
                <div className="rounded-2xl border border-zinc-800 p-4 bg-zinc-900/40">
                  <div className="text-sm text-zinc-400 mb-2">è¦é»</div>
                  <ul className="list-disc list-inside text-zinc-300 space-y-1">{current.bullets.map((b, i) => <li key={i}>{b}</li>)}</ul>
                </div>
                <div className="rounded-2xl border border-zinc-800 p-4 bg-zinc-900/40">
                  <div className="text-sm text-zinc-400 mb-2">é—œè¯å‡½å¼ï¼ˆé»æ“Šè·³è‡³èªªæ˜ï¼‰</div>
                  <div className="flex flex-wrap gap-2">
                    {current.functions.map((f, i) => (
                      <button
                        key={`${current.id}:${f}`}
                        onClick={() => onGotoFunc(f)}
                        title={`å‰å¾€ ${f} çš„èªªæ˜`}
                        className="px-2 py-1 rounded-lg border border-emerald-700/50 bg-emerald-500/10 hover:bg-emerald-500/20 text-sm cursor-pointer"
                      >{f}</button>
                    ))}
                  </div>
                </div>
              </div>
              <div>
                <Accordion items={[
                  { header: "å¿«é€Ÿç¯„ä¾‹ï¼šæœ€çŸ­å¯ç”¨åœ–", sub: "plot + show", content: <CodeBlock key="uses/quick-plot" code={current.quick} /> },
                ]} />
              </div>
            </div>
          </section>
        );
      }

      function Demos({ sub, setSub }) {
        const current = DEMOS.find((d) => d.id === sub) || DEMOS[0];
        return (
          <section className="grid lg:grid-cols-[280px,1fr] gap-6">
            <aside>
              <div className="text-xs uppercase tracking-wider text-zinc-400 mb-2">æ¼”ç¤ºæ¸…å–®</div>
              <div className="space-y-1">
                {DEMOS.map((d) => (
                  <button key={d.id} onClick={() => setSub(d.id)} className={`w-full text-left px-3 py-2 rounded-xl border ${current.id===d.id?"border-emerald-600 bg-emerald-500/10":"border-zinc-700 hover:bg-zinc-800/60"}`}>{d.title}</button>
                ))}
              </div>
            </aside>
            <div className="space-y-5">
              <header className="space-y-1">
                <div className="text-sm text-zinc-400">ç›®æ¨™</div>
                <h2 className="text-2xl font-semibold">{current.title}</h2>
                <p className="text-zinc-300">{current.goal}</p>
              </header>
              <CodeBlock key={current.id} code={current.code} />
            </div>
          </section>
        );
      }

      function Funcs({ sub, setSub, itemSlug }) {
        const current = FUNCTIONS.find((c) => c.id === sub) || FUNCTIONS[0];

        useEffect(() => {
          if (!itemSlug) return;
          const el = document.getElementById('func-item-' + itemSlug);
          if (el) {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            el.classList.add('ring-2','ring-emerald-500');
            setTimeout(() => el.classList.remove('ring-2','ring-emerald-500'), 1200);
          }
        }, [itemSlug, current.id]);

        return (
          <section className="grid lg:grid-cols-[300px,1fr] gap-6">
            <aside>
              <div className="text-xs uppercase tracking-wider text-zinc-400 mb-2">åˆ†é¡</div>
              <div className="space-y-1">
                {FUNCTIONS.map((c) => (
                  <button key={c.id} onClick={() => setSub(c.id)} className={`w-full text-left px-3 py-2 rounded-xl border ${current.id===c.id?"border-emerald-600 bg-emerald-500/10":"border-zinc-700 hover:bg-zinc-800/60"}`}>{c.title}</button>
                ))}
              </div>
            </aside>
            <div className="space-y-6">
              <header>
                <h2 className="text-2xl font-semibold mb-1">{current.title}</h2>
                <p className="text-zinc-300">å¸¸ç”¨å‡½å¼èˆ‡æœ€å°å¯è¡Œç¯„ä¾‹ï¼Œå¯ç›´æ¥åŸ·è¡Œï¼›éœ€è¦æ™‚å¯åˆ‡æ›ã€Œæ¯è¡Œè¨»è§£ã€ã€‚</p>
              </header>
              <div className="space-y-6">
                {current.items.map((it) => {
                  const slug = slugifyItemName(it.name);
                  const k = `${current.id}:${slug}`;
                  return (
                    <div id={`func-item-${slug}`} key={k} className="rounded-2xl border border-zinc-800 p-4 bg-zinc-900/40 space-y-3">
                      <div className="flex flex-wrap items-center gap-x-3 gap-y-1">
                        <div className="font-mono text-emerald-300 text-sm">{it.name}</div>
                        {it.desc && <span className="text-xs text-zinc-400">â€” {it.desc}</span>}
                      </div>
                      {it.what && (<div><div className="text-sm text-zinc-400 mb-1">ä½œç”¨</div><p className="text-zinc-300 leading-relaxed">{it.what}</p></div>)}
                      {(it.uses && it.uses.length>0) && (<div><div className="text-sm text-zinc-400 mb-1">å¸¸è¦‹ç”¨é€”</div><ul className="list-disc list-inside text-zinc-300 space-y-1">{it.uses.map((u, idx) => <li key={`${k}:use:${idx}`}>{u}</li>)}</ul></div>)}
                      {it.code && <CodeBlock key={`${k}:code`} code={it.code} />}
                    </div>
                  );
                })}
              </div>
            </div>
          </section>
        );
      }

      function Site() {
        const [section, setSection] = useState("home");
        const [sub, setSub] = useState(null);
        const [itemSlug, setItemSlug] = useState(null);

        useEffect(() => {
          const syncFromHash = () => {
            const raw = window.location.hash.replace(/^#\/?/, "");
            if (!raw) return;
            const [path, query] = raw.split("?");
            const [s, p] = path.split("/");
            if (["home","uses","demos","funcs"].includes(s)) {
              setSection(s);
              setSub(p || null);
            }
            const qs = new URLSearchParams(query || "");
            const it = qs.get("item");
            setItemSlug(it || null);
          };
          syncFromHash();
          window.addEventListener("hashchange", syncFromHash);
          return () => window.removeEventListener("hashchange", syncFromHash);
        }, []);

        useEffect(() => {
          let newHash = section + (sub ? "/" + sub : "");
          if (section === 'funcs' && itemSlug) newHash += `?item=${itemSlug}`;
          if (window.location.hash !== "#" + newHash) window.location.hash = newHash;
        }, [section, sub, itemSlug]);

        const gotoFunctionDetail = (label) => {
          for (const c of FUNCTIONS) {
            for (const it of c.items) {
              const tokens = tokensFromName(it.name);
              if (tokens.includes(label) || it.name.startsWith(label) || it.name.includes(label)) {
                const slug = slugifyItemName(it.name);
                setSection('funcs'); setSub(c.id); setItemSlug(slug);
                requestAnimationFrame(() => setTimeout(() => {
                  const el = document.getElementById('func-item-' + slug);
                  if (el) {
                    el.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    el.classList.add('ring-2','ring-emerald-500');
                    setTimeout(() => el.classList.remove('ring-2','ring-emerald-500'), 1200);
                  }
                }, 30));
                return;
              }
            }
          }
          alert(`å°šæœªæ”¶éŒ„ã€Œ${label}ã€çš„èªªæ˜ã€‚`);
        };

        const trail = useMemo(() => {
          const t = [{ label: "é¦–é " }];
          if (section === "uses") t.push({ label: "ç”¨é€”" });
          if (section === "demos") t.push({ label: "å‡½å¼/å°ˆæ¡ˆæ¼”ç¤º" });
          if (section === "funcs") t.push({ label: "å‡½å¼ç´°ç¯€èˆ‡ç¯„ä¾‹" });
          if (sub) {
            const label = (section === "uses" && USE_CASES.find((u) => u.id === sub)?.title)
              || (section === "demos" && DEMOS.find((d) => d.id === sub)?.title)
              || (section === "funcs" && FUNCTIONS.find((c) => c.id === sub)?.title)
              || null;
            if (label) t.push({ label });
          }
          return t;
        }, [section, sub]);

        return (
          <RunProvider>
            <PyProvider>
              <div className="min-h-screen">
                <Header section={section} setSection={setSection} />
                <main className="max-w-7xl mx-auto px-4 py-6">
                  <div className="mb-4"><Breadcrumbs trail={trail} /></div>
                  {section === "home" && <Home setSection={setSection} />}
                  {section === "uses" && <Uses sub={sub} setSub={setSub} onGotoFunc={gotoFunctionDetail} />}
                  {section === "demos" && <Demos sub={sub} setSub={setSub} />}
                  {section === "funcs" && <Funcs sub={sub} setSub={setSub} itemSlug={itemSlug} />}
                </main>
                <footer className="border-t border-zinc-800 mt-8">
                  <div className="max-w-7xl mx-auto px-4 py-6 text-sm text-zinc-400 flex flex-wrap items-center gap-2">
                    <span>Â© {new Date().getFullYear()} Matplotlib æ‡¶äººåŒ…</span>
                    <span className="mx-2">Â·</span>
                    <span>ä½ˆç½²ï¼šGitHub Pages / Vercel</span>
                  </div>
                </footer>
              </div>
            </PyProvider>
          </RunProvider>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<Site />);
    </script>
  </body>
</html>
